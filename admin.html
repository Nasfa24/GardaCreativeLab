<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCL - Dashboard Kurator</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%2303754c%22/><text x=%2250%22 y=%2270%22 font-family=%22Arial, sans-serif%22 font-size=%2270%22 font-weight=%22bold%22 fill=%22white%22 text-anchor=%22middle%22>G</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #03754c; --bg: #F5F7FA; --secondary: #FFC107; --danger: #FF5252; --text: #333; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 16px; width: 320px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 8px; font-size: 1rem; outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: #FF9800; color: white; }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        #dashboard { display: none; max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stats-container { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); text-align: center; border-bottom: 4px solid var(--primary); }
        .stat-box:nth-child(2) { border-bottom-color: var(--secondary); }
        .stat-num { font-size: 2.2rem; font-weight: 700; color: var(--primary); line-height: 1; margin-bottom: 5px; }
        .stat-box:nth-child(2) .stat-num { color: #F57C00; }
        .stat-label { font-size: 0.85rem; color: #666; font-weight: 600; text-transform: uppercase; }
        
        .tabs-wrapper { overflow-x: auto; white-space: nowrap; margin-bottom: 20px; padding-bottom: 5px; }
        .tabs { display: inline-flex; gap: 10px; }
        .tab { padding: 10px 20px; background: white; border-radius: 30px; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: #666; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .tab.active { background: var(--primary); color: white; }
        .hidden { display: none; }
        
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ccc; flex-wrap: wrap; gap:10px; }
        .card-wd { border-left-color: var(--secondary); }
        .card-pending { border-left-color: #2196F3; }
        .card-reval { border-left-color: #FF9800; background: #FFFDF5; } 
        .card-approved { border-left-color: #4CAF50; }
        .card-rejected { border-left-color: var(--danger); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; background: #eee; display: inline-block; }
        .badge-points { background: #E8F5E9; color: var(--primary); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 30px; max-height: 90vh; overflow-y: auto; }
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .calc-grid input { text-align: center; font-weight: bold; font-size:1.2rem; }
        .checkbox-group { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .checkbox-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.9rem; cursor: pointer; }
        .checkbox-item input { margin-right: 10px; transform: scale(1.2); }
        .result-box { background: var(--primary); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .result-points { font-size: 2.5rem; font-weight: 800; color: var(--secondary); line-height: 1; margin: 10px 0; }
        
        .gcl-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; display: none; align-items: center; justify-content: center; }
        .dialog-box { background: white; width: 85%; max-width: 350px; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .dialog-btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .d-btn { flex: 1; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; }
        .d-btn-cancel { background: #eee; color: #555; }
        .d-btn-ok { background: var(--primary); color: white; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 12px 25px; border-radius: 30px; z-index: 9999; transition: 0.4s; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h2 style="margin-bottom: 5px;">GCL ADMIN</h2>
        <p style="margin-bottom: 20px; opacity: 0.8;">Gerbang Kurator</p>
        <div class="login-box">
            <input type="text" id="adminUser" class="form-input" placeholder="Username">
            <input type="password" id="adminPass" class="form-input" placeholder="Password">
            <button class="btn" onclick="checkLogin()">MASUK</button>
            <p id="loginMsg" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="dashboard">
        <div class="header">
            <div><h2 style="color:var(--primary); margin:0;">Ruang Kurasi</h2><div style="font-size:0.8rem; color:#666;">Garda Creative Lab</div></div>
            <button onclick="logoutAdmin()" class="btn btn-outline" style="width:auto; padding:8px 15px;"><i class="fas fa-sign-out-alt"></i> Keluar</button>
        </div>

        <div class="stats-container">
            <div class="stat-box"><div class="stat-num" id="statKreator">0</div><div class="stat-label"><i class="fas fa-users"></i> Total Kreator</div></div>
            <div class="stat-box"><div class="stat-num" id="statKarya">0</div><div class="stat-label"><i class="fas fa-check-circle"></i> Karya Diterima</div></div>
        </div>

        <div class="tabs-wrapper">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('pending')"><i class="fas fa-inbox"></i> Antrian Validasi</div>
                <div class="tab" onclick="switchTab('history')"><i class="fas fa-history"></i> Riwayat Karya</div>
                <div class="tab" onclick="switchTab('wd')"><i class="fas fa-wallet"></i> Permintaan WD</div>
                <div class="tab" onclick="switchTab('wd-done')"><i class="fas fa-check-double"></i> Histori WD (Selesai)</div>
            </div>
        </div>

        <div id="panel-pending"><div id="listPending"><p style="text-align:center; color:#888;">Memuat data...</p></div></div>
        <div id="panel-history" class="hidden">
            <div style="margin-bottom:15px; background:#fff; padding:15px; border-radius:12px; font-size:0.85rem; color:#666;"><i class="fas fa-info-circle"></i> Daftar karya yang sudah dinilai. Klik <b>"Edit Nilai"</b> jika ada karya yang bertambah viral.</div>
            <div id="listHistory"><p style="text-align:center; color:#888;">Memuat data...</p></div>
        </div>
        <div id="panel-wd" class="hidden"><div id="listWd"><p style="text-align:center; color:#888;">Memuat data...</p></div></div>
        <div id="panel-wd-done" class="hidden"><div id="listWdDone"><p style="text-align:center; color:#888;">Memuat data...</p></div></div>
    </div>

    <div class="modal-overlay" id="calcModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--primary);">Kalkulator Poin</h3>
                <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="closeModal()"></i>
            </div>
            
            <div style="font-size:0.85rem; margin-bottom:15px; color:#555;">
                Kreator: <b id="calcKreatorName">...</b><br>
                Link: <a href="#" id="calcLink" target="_blank" style="color:blue;">Buka Postingan Asli</a>
            </div>

            <label style="font-size:0.8rem; font-weight:bold; color:#666;">Engagement Baru:</label>
            <div class="calc-grid">
                <div><small>Views</small><input type="number" id="c_views" class="form-input" placeholder="0" oninput="liveCalc()"></div>
                <div><small>Likes</small><input type="number" id="c_likes" class="form-input" placeholder="0" oninput="liveCalc()"></div>
                <div><small>Comments</small><input type="number" id="c_comments" class="form-input" placeholder="0" oninput="liveCalc()"></div>
            </div>

            <div id="critArea">
                <label style="font-size:0.8rem; font-weight:bold; color:#666;">Kriteria Konten (Centang yang ada):</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" class="c_crit" value="7" onchange="liveCalc()"> Sosok Gus Muhaimin (+7)</label>
                    <label class="checkbox-item"><input type="checkbox" class="c_crit" value="5" onchange="liveCalc()"> Logo / Atribut PKB (+5)</label>
                    <label class="checkbox-item"><input type="checkbox" class="c_crit" value="4" onchange="liveCalc()"> Aktor/Tokoh PKB Lain (+4)</label>
                    <label class="checkbox-item"><input type="checkbox" class="c_crit" value="2" onchange="liveCalc()"> Pesan Politik/Kebijakan (+2)</label>
                    <label class="checkbox-item"><input type="checkbox" class="c_crit" value="2" onchange="liveCalc()"> Edukasi Bermanfaat (+2)</label>
                    <label class="checkbox-item"><input type="checkbox" class="c_crit" value="2" onchange="liveCalc()"> Mengikuti Trend Aktif (+2)</label>
                </div>
            </div>
            
            <div id="lockedCritMsg" style="display:none; background:#E8F5E9; color:#2E7D32; padding:12px; border-radius:8px; font-size:0.8rem; font-weight:600; margin-bottom:20px; text-align:center;">
                <i class="fas fa-lock"></i> Kriteria konten dikunci dari penilaian awal. Cukup ubah angka Views/Likes/Comments.
            </div>

            <div class="result-box">
                <div style="font-size:0.8rem;">Estimasi Poin Akhir</div>
                <div class="result-points" id="c_result">0</div>
                <div id="c_warning" style="font-size:0.75rem; color:#FFCDD2; display:none;"><i class="fas fa-exclamation-triangle"></i> Pinalti: Kriteria kurang dari 2 (Poin dibagi 10)</div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="submitGrade('rejected')"><i class="fas fa-times"></i> Tolak</button>
                <button class="btn" onclick="submitGrade('approved')"><i class="fas fa-check"></i> Simpan & Approve</button>
            </div>
        </div>
    </div>

    <div class="gcl-dialog" id="gclDialog">
        <div class="dialog-box">
            <h3 id="dTitle" style="margin-bottom:10px; color:var(--primary);">Konfirmasi</h3>
            <p id="dMsg" style="font-size:0.9rem; color:#555; margin-bottom:20px;">Pesan disini</p>
            <div class="dialog-btn-row">
                <button class="d-btn d-btn-cancel" id="dBtnCancel" onclick="closeDialog()">Batal</button>
                <button class="d-btn d-btn-ok" id="dBtnOk">YA</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Berhasil!</div>

    <script>
        const ADMIN_USERNAME = "admin"; const ADMIN_PASSWORD = "gcl2026";
        const firebaseConfig = { apiKey: "AIzaSyArd38MI6bL4EI6Q4oW-VJA_SnM0Ky35Js", authDomain: "gardacreativelab.firebaseapp.com", projectId: "gardacreativelab", storageBucket: "gardacreativelab.firebasestorage.app", messagingSenderId: "983029298298", appId: "1:983029298298:web:5911967a358adb373df7c3" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        let currentDocId = null; let currentUserId = null; let oldScore = 0;
        let activeMultiplier = 0; let currentCalculatedMultiplier = 0;

        window.onload = function() { if (sessionStorage.getItem('gclAdminLoggedIn') === 'true') { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; initDashboard(); } };

        function checkLogin() { if(document.getElementById('adminUser').value === ADMIN_USERNAME && document.getElementById('adminPass').value === ADMIN_PASSWORD) { sessionStorage.setItem('gclAdminLoggedIn', 'true'); document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; initDashboard(); } else { document.getElementById('loginMsg').innerText = "Username atau Password salah!"; } }
        function logoutAdmin() { showDialog("Keluar", "Akhiri sesi Kurator?", () => { sessionStorage.removeItem('gclAdminLoggedIn'); window.location.reload(); }); }

        function initDashboard() { loadStats(); loadPending(); loadHistory(); loadWD(); loadWDDone(); }

        function loadStats() {
            db.collection("users").onSnapshot(snap => { document.getElementById('statKreator').innerText = snap.size; });
            db.collection("submissions").where("status", "==", "approved").onSnapshot(snap => { document.getElementById('statKarya').innerText = snap.size; });
        }

        // FUNGSI BARU: HAPUS KONTEN PERMANEN (DENGAN REVISI SALDO JIKA DIPERLUKAN)
        function deleteSubmission(docId, userId, pointsAwarded) {
            showDialog("Hapus Permanen", "Yakin ingin menghapus karya ini? Jika karya ini sudah pernah dapat poin, saldo Kreator akan dipotong secara otomatis.", () => {
                // Tarik kembali poin jika statusnya pernah approved
                if(pointsAwarded > 0) {
                    db.collection("users").doc(userId).update({ balance: firebase.firestore.FieldValue.increment(-pointsAwarded) });
                }
                // Hapus dokumen
                db.collection("submissions").doc(docId).delete()
                .then(() => showToast("Karya berhasil dihapus!"))
                .catch(e => showDialog("Error", e.message, null, true));
            });
        }

        function loadPending() {
            db.collection("submissions").where("status", "==", "pending").onSnapshot(snap => {
                const div = document.getElementById("listPending"); div.innerHTML = "";
                if(snap.empty) { div.innerHTML = "<p style='text-align:center;'>Hore! Tidak ada antrian validasi.</p>"; return; }
                
                let dataList = []; snap.forEach(doc => dataList.push({ id: doc.id, ...doc.data() }));
                dataList.sort((a, b) => { let tA = a.createdAt ? a.createdAt.seconds : 0; let tB = b.createdAt ? b.createdAt.seconds : 0; return tB - tA; });

                dataList.forEach(d => {
                    const dateStr = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString() : '-';
                    let typeBadge = `<span class="badge" style="background:#E3F2FD; color:#1976D2;">KARYA BARU</span>`;
                    let borderStyle = "card-pending"; let oldPtsText = "";

                    if(d.isReval) {
                        typeBadge = `<span class="badge" style="background:#FFF3E0; color:#FF9800;"><i class="fas fa-sync-alt"></i> REVISI NILAI</span>`;
                        borderStyle = "card-reval"; oldPtsText = `<div style="font-size:0.8rem; color:#FF9800; font-weight:bold; margin-top:5px;">Poin Sebelumnya: ${d.pointsAwarded || 0}</div>`;
                    }

                    let mul = d.savedMultiplier || 0;
                    let validLink = d.link; if (!validLink.match(/^https?:\/\//i)) { validLink = 'https://' + validLink; }

                    // TAMBAHAN TOMBOL HAPUS DI KARTU ANTRIAN
                    div.innerHTML += `
                        <div class="card ${borderStyle}">
                            <div style="flex-grow:1;">
                                <b>${d.userName}</b> ${typeBadge} <span class="badge">${d.platform.toUpperCase()}</span><br>
                                <div style="font-size:0.8rem; color:#666; margin:2px 0;">${dateStr}</div>
                                ${oldPtsText}
                                <div style="margin-top:5px; margin-bottom:10px;">
                                    <a href="${validLink}" target="_blank" style="font-size:0.9rem; color:#1976D2; text-decoration:none;"><i class="fas fa-external-link-alt"></i> Buka Postingan Asli</a>
                                </div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:8px; min-width:140px;">
                                <button class="btn btn-warning" style="padding:8px; font-size:0.85rem;" onclick="auditWA('${d.userId}', '${validLink}')"><i class="fab fa-whatsapp"></i> Audit via WA</button>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn" style="padding:8px; flex:1; font-size:0.85rem;" onclick="openCalc('${d.id}', '${d.userId}', '${d.userName}', '${validLink}', ${d.pointsAwarded || 0}, ${mul})">Nilai</button>
                                    <button class="btn btn-danger" style="padding:8px; width:45px; flex:none;" onclick="deleteSubmission('${d.id}', '${d.userId}', ${d.pointsAwarded || 0})" title="Hapus Karya"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>`;
                });
            });
        }

        function auditWA(userId, link) {
            db.collection("users").doc(userId).get().then(doc => {
                if(doc.exists && doc.data().whatsapp) {
                    let wa = doc.data().whatsapp.toString().replace(/\D/g,'');
                    if(wa.startsWith('0')) wa = '62' + wa.substring(1);
                    let msg = `Halo, kak. Saya dari Garda Creative Lab mau konfirmasi, apakah benar konten ini milik anda?\n\nLink: ${link}`;
                    window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`, '_blank');
                } else { showDialog("Gagal", "Kreator ini belum mengisi nomor WhatsApp di profilnya.", null, true); }
            }).catch(e => { showToast("Error mengambil data WA"); });
        }

        function loadHistory() {
            db.collection("submissions").where("status", "in", ["approved", "rejected"]).onSnapshot(snap => {
                const div = document.getElementById("listHistory"); div.innerHTML = "";
                if(snap.empty) { div.innerHTML = "<p style='text-align:center;'>Belum ada riwayat penilaian.</p>"; return; }
                let dataList = []; snap.forEach(doc => dataList.push({ id: doc.id, ...doc.data() }));
                dataList.sort((a, b) => { let tA = a.createdAt ? a.createdAt.seconds : 0; let tB = b.createdAt ? b.createdAt.seconds : 0; return tB - tA; });
                let top50 = dataList.slice(0, 50);
                
                top50.forEach(d => {
                    let badgeColor = d.status === 'approved' ? 'card-approved' : 'card-rejected';
                    let statusText = d.status === 'approved' ? `<span class="badge badge-points">+${d.pointsAwarded} Poin</span>` : `<span class="badge" style="background:#FFEBEE; color:red;">Ditolak</span>`;
                    let mul = d.savedMultiplier || 0;
                    let validLink = d.link; if (!validLink.match(/^https?:\/\//i)) { validLink = 'https://' + validLink; }

                    // TAMBAHAN TOMBOL HAPUS DI KARTU RIWAYAT
                    div.innerHTML += `
                        <div class="card ${badgeColor}">
                            <div style="flex-grow:1;">
                                <b>${d.userName}</b> ${statusText}<br>
                                <a href="${validLink}" target="_blank" style="font-size:0.8rem; color:#1976D2; text-decoration:none;"><i class="fas fa-link"></i> Buka Konten</a>
                            </div>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <button class="btn btn-outline" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="openCalc('${d.id}', '${d.userId}', '${d.userName}', '${validLink}', ${d.pointsAwarded || 0}, ${mul})"><i class="fas fa-edit"></i> Edit Nilai</button>
                                <button class="btn btn-danger" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="deleteSubmission('${d.id}', '${d.userId}', ${d.pointsAwarded || 0})" title="Hapus Permanen"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                });
            });
        }

        function loadWD() {
            db.collection("withdrawals").where("status", "in", ["pending", "transferred"]).onSnapshot(snap => {
                const div = document.getElementById("listWd"); div.innerHTML = "";
                if(snap.empty) { div.innerHTML = "<p style='text-align:center;'>Tidak ada antrian pencairan.</p>"; return; }
                snap.forEach(doc => {
                    const d = doc.data(); let cleanWA = d.userWa ? d.userWa.toString().replace(/\D/g,'') : ''; if(cleanWA.startsWith('0')) cleanWA = '62' + cleanWA.substring(1);
                    const linkWA = `https://wa.me/${cleanWA}?text=${encodeURIComponent(`Halo, ${d.userName}, saya Kurator GCL. Penarikan Dana sebesar ${d.amount} Poin telah ditransfer, mohon cek dan klik tombol Terima di Aplikasi.`)}`;
                    let action = d.status === "pending" ? `<button class="btn" style="background:#4CAF50;" onclick="markTransfer('${doc.id}', '${linkWA}')"><i class="fab fa-whatsapp"></i> Sudah Transfer</button>` : `<span style="color:green; font-size:0.8rem; font-weight:bold;">âœ… Menunggu Kreator Terima</span>`;
                    div.innerHTML += `<div class="card card-wd" style="display:block;"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><h3 style="color:var(--primary); margin:0;">${d.amount} Poin</h3><small>${d.status.toUpperCase()}</small></div><p style="margin:5px 0;"><b>${d.userName}</b> (NIK: ${d.userNik || '-'})</p><div style="background:#eee; padding:10px; border-radius:8px; font-size:0.9rem; margin-bottom:10px;">Bank: <b>${d.bankDetails}</b><br>WA: ${d.userWa}</div>${action}</div>`;
                });
            });
        }

        function loadWDDone() {
            db.collection("withdrawals").where("status", "==", "completed").onSnapshot(snap => {
                const div = document.getElementById("listWdDone"); div.innerHTML = "";
                if(snap.empty) { div.innerHTML = "<p style='text-align:center;'>Belum ada histori selesai.</p>"; return; }
                let dataList = []; snap.forEach(doc => dataList.push({ id: doc.id, ...doc.data() }));
                dataList.sort((a, b) => { let tA = a.completedAt ? a.completedAt.seconds : 0; let tB = b.completedAt ? b.completedAt.seconds : 0; return tB - tA; });
                let top50 = dataList.slice(0, 50);
                top50.forEach(d => {
                    div.innerHTML += `<div class="card" style="border-left-color:green; display:block;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><h3 style="color:green; margin:0;">${d.amount} Poin</h3><small>${d.completedAt ? new Date(d.completedAt.seconds * 1000).toLocaleDateString() : ''}</small></div><p style="margin:0 0 5px 0;"><b>${d.userName}</b></p><div style="font-size:0.85rem; color:#666;">Ke: ${d.bankDetails}</div></div>`;
                });
            });
        }

        function markTransfer(docId, waLink) { showDialog("Konfirmasi Transfer", "Pastikan Anda sudah mentransfer uang via M-Banking. Lanjut update status?", () => { db.collection("withdrawals").doc(docId).update({ status: "transferred" }).then(() => { window.open(waLink, '_blank'); }); }); }

        function openCalc(docId, userId, userName, link, currentPts, savedMult = 0) {
            currentDocId = docId; currentUserId = userId; oldScore = currentPts; activeMultiplier = savedMult;
            document.getElementById('c_views').value = ''; document.getElementById('c_likes').value = ''; document.getElementById('c_comments').value = '';
            document.querySelectorAll('.c_crit').forEach(cb => cb.checked = false);
            document.getElementById('calcKreatorName').innerText = userName; document.getElementById('calcLink').href = link;
            
            if(activeMultiplier > 0) {
                document.getElementById('critArea').style.display = 'none'; document.getElementById('lockedCritMsg').style.display = 'block';
            } else {
                document.getElementById('critArea').style.display = 'block'; document.getElementById('lockedCritMsg').style.display = 'none';
            }

            liveCalc(); document.getElementById('calcModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('calcModal').style.display = 'none'; }

        function liveCalc() {
            let v = parseInt(document.getElementById('c_views').value) || 0; let l = parseInt(document.getElementById('c_likes').value) || 0; let c = parseInt(document.getElementById('c_comments').value) || 0;
            let baseScore = (v * 0.01) + (l * 0.012) + (c * 0.015);
            let m = activeMultiplier;
            const warn = document.getElementById('c_warning');

            if (activeMultiplier === 0) {
                let tempM = 0; let checkedCount = 0;
                document.querySelectorAll('.c_crit:checked').forEach(cb => { tempM += parseInt(cb.value); checkedCount++; });
                if(tempM === 0) tempM = 1; 
                
                if(checkedCount < 2) { m = tempM / 10; warn.style.display = 'block'; } else { m = tempM; warn.style.display = 'none'; }
                currentCalculatedMultiplier = m; 
            } else { warn.style.display = 'none'; currentCalculatedMultiplier = activeMultiplier; }

            let finalScore = baseScore * currentCalculatedMultiplier;
            document.getElementById('c_result').innerText = Math.round(finalScore);
        }

        function submitGrade(newStatus) {
            let finalPoints = parseInt(document.getElementById('c_result').innerText) || 0;
            if (newStatus === 'rejected') { finalPoints = 0; currentCalculatedMultiplier = 0; }
            let delta = finalPoints - oldScore;

            db.collection("submissions").doc(currentDocId).update({
                status: newStatus, pointsAwarded: finalPoints, savedMultiplier: currentCalculatedMultiplier, isReval: false, evaluatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                if(delta !== 0) { return db.collection("users").doc(currentUserId).update({ balance: firebase.firestore.FieldValue.increment(delta) }); }
            }).then(() => {
                closeModal(); showToast(`Selesai! Saldo disesuaikan (${delta > 0 ? '+'+delta : delta} Poin).`);
            }).catch(e => showDialog("Error", e.message, null, true));
        }

        function switchTab(tab) { document.getElementById('panel-pending').classList.add('hidden'); document.getElementById('panel-history').classList.add('hidden'); document.getElementById('panel-wd').classList.add('hidden'); document.getElementById('panel-wd-done').classList.add('hidden'); document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.getElementById('panel-'+tab).classList.remove('hidden'); event.target.classList.add('active'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function showDialog(title, msg, onConfirm, isAlert = false) {
            document.getElementById('dTitle').innerText = title; document.getElementById('dMsg').innerText = msg; document.getElementById('gclDialog').style.display = 'flex';
            if(isAlert) { document.getElementById('dBtnCancel').style.display = 'none'; document.getElementById('dBtnOk').innerText = 'Tutup'; } else { document.getElementById('dBtnCancel').style.display = 'block'; document.getElementById('dBtnOk').innerText = 'YA'; }
            document.getElementById('dBtnOk').onclick = function() { closeDialog(); if(onConfirm) onConfirm(); };
        }
        function closeDialog() { document.getElementById('gclDialog').style.display = 'none'; }
    </script>
</body>
</html>